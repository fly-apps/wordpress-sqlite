# Wordpress on Fly

The goal of this setup was to get Fly working with Sqlite, based on [this announcement](https://make.wordpress.org/core/2022/12/20/help-us-test-the-sqlite-implementation/).

This requires the [Performance Lab](https://wordpress.org/plugins/performance-lab/) plugin, which can then be used to enable SQLite.

## Hard Parts

1. Enabling SQLite from the Perf Lab settings in the WP Admin dashboard triggers some work that isn't easily automated.
    - This creates a SQLite database, copies certain data over to it (users, basis config, but no content) and then creates a PHP file that over-rides the default database configuration
2. You can't easily automate installing a plugin from a `docker build...` context as it requires a working database to add records to
3. We had to hack some configuration so `X-Forwarded-*` headers were read correctly

So, Dockerizing a working Wordpress site with SQLite had some interesting parts to it!

## Solutions

The Docker image that had SQLite is a Wordpress installation that already had the Perf Labs plugin installed into the `wp-content` directory.

It also has an "empty" SQLite database which contains a username and password, and data about the Perf Labs plugin. The username/password is noted in the `README.md` file and is unfortunately hard-coded, but people should change the username/password for themselves 
after initial setup.

* `wp-content/database/.ht.sqlite` is that "empty" database file
* `wp-content/plugins/performance-lab` contains the perf lab plugin files
* `wp-content/db.php` is a file generated by Perf Labs that over-rides the database configuration and instead reads from the `.ht.sqlite` database file
* `wp-config.php` is Wordpress's default configuration file used in the official WP Docker image. We had to hack this a bit to get `X-Forwarded-*` headers working (or rather, to get Wordpress to read the correct HTTP_HOST and SSL usage). We added this on line 42:

```php
if (isset($_ENV['FLY_ALLOC_ID'])) {
    $host = $_SERVER['HTTP_HOST'];
    define('WP_HOME', 'https://'.$host);
    define('WP_SITEURL', 'https://'.$host);
    $_SERVER['HTTPS'] = 'on';
}
```

